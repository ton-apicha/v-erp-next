// ===========================================
// V-ERP Prisma Schema
// Version: 2.0.0 (Enhanced for Blueprint)
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================================
// User & Authentication
// =========================================
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          UserRole  @default(STAFF)
  
  // Preferences
  language      String    @default("th")  // th, en, la
  theme         String    @default("system") // light, dark, system
  
  // Meta
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  createdWorkers       Worker[]   @relation("CreatedBy")
  createdAgents        Agent[]    @relation("CreatedBy")
  createdClients       Client[]   @relation("CreatedBy")
  createdLoans         Loan[]     @relation("CreatedLoans")
  recordedPayments     Payment[] @relation("RecordedPayments")
  calculatedCommissions Commission[] @relation("CalculatedCommissions")
  approvedCommissions  Commission[] @relation("ApprovedCommissions")
  auditLogs            AuditLog[]
  notifications        Notification[]
  sosResolutions       SosAlert[] @relation("ResolvedBy")
}

enum UserRole {
  SUPER_ADMIN   // เห็นทุกอย่าง ลบได้
  MANAGER       // เห็นทุกอย่าง แต่ลบไม่ได้
  STAFF         // ทำงานปกติ
}

// =========================================
// Worker Management
// =========================================
model Worker {
  id            String    @id @default(cuid())
  workerId      String    @unique // Auto: WK-XXXX
  
  // Personal Info
  firstNameTH   String
  lastNameTH    String
  firstNameEN   String?
  lastNameEN    String?
  firstNameLA   String?
  lastNameLA    String?
  nickname      String?
  gender        Gender
  dateOfBirth   DateTime
  nationality   String        @default("LAO")
  religion      String?
  
  // Contact
  phoneNumber   String?
  email         String?
  lineId        String?
  address       String?
  
  // Emergency Contact
  emergencyName     String?
  emergencyPhone    String?
  emergencyRelation String?
  
  // Employment
  status        WorkerStatus  @default(NEW_LEAD)
  agentId       String?
  clientId      String?
  position      String?
  salary        Decimal?      @db.Decimal(12, 2)
  startDate     DateTime?
  endDate       DateTime?
  
  // Processing
  screeningNotes  String?
  academyStartDate DateTime?
  academyEndDate   DateTime?
  
  // Deployment
  deploymentDate DateTime?
  returnDate     DateTime?
  
  // Health
  bloodType      String?
  allergies      String?
  medicalConditions String?
  
  // Documents Status
  passportNo     String?
  passportExpiry DateTime?
  visaNo         String?
  visaExpiry     DateTime?
  workPermitNo   String?
  workPermitExpiry DateTime?
  
  // Meta
  isArchived    Boolean   @default(false)
  notes         String?
  createdById   String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  createdBy     User        @relation("CreatedBy", fields: [createdById], references: [id])
  agent         Agent?      @relation(fields: [agentId], references: [id])
  client        Client?     @relation(fields: [clientId], references: [id])
  documents     Document[]
  loans         Loan[]
  sosAlerts     SosAlert[]
  
  @@index([status])
  @@index([nationality])
  @@index([agentId])
  @@index([clientId])
}

enum WorkerStatus {
  NEW_LEAD      // รายชื่อใหม่
  SCREENING     // รอตรวจสอบ
  PROCESSING    // กำลังดำเนินการเอกสาร
  ACADEMY       // ฝึกอบรม
  READY         // พร้อมส่งตัว
  DEPLOYED      // ส่งตัวแล้ว
  WORKING       // กำลังทำงาน
  CONTRACT_END  // สิ้นสุดสัญญา
  TERMINATED    // ยกเลิก
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

// =========================================
// Partner: Agents (ตัวแทน)
// =========================================
model Agent {
  id            String      @id @default(cuid())
  agentId       String      @unique // Auto: A-XXXX
  
  // Company Info
  companyName   String
  contactPerson String
  phoneNumber   String
  email         String?
  address       String?
  taxId         String?
  
  // Commission
  commissionRate Decimal    @default(0) @db.Decimal(5, 2)
  tier          Int         @default(1) // 1, 2, 3
  
  // Performance Metrics (calculated)
  totalRecruits Int         @default(0)
  passRate      Decimal?    @db.Decimal(5, 2) // %
  dropoutRate   Decimal?    @db.Decimal(5, 2) // %
  
  // Meta
  status        AgentStatus @default(PENDING)
  notes         String?
  createdById   String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  createdBy     User        @relation("CreatedBy", fields: [createdById], references: [id])
  workers       Worker[]
  documents     Document[]
  commissions   Commission[]
  materials     MaterialIssue[]
  
  @@index([status])
  @@index([taxId])
}

enum AgentStatus {
  PENDING   // รออนุมัติ
  ACTIVE    // ใช้งานได้
  SUSPENDED // ระงับชั่วคราว
  BANNED    // แบนถาวร
}

// =========================================
// Partner: Clients (นายจ้าง)
// =========================================
model Client {
  id            String   @id @default(cuid())
  clientId      String   @unique // Auto: C-XXXX
  
  // Company Info
  companyName   String
  companyNameEN String?
  contactPerson String
  phoneNumber   String
  email         String?
  address       String?
  taxId         String?
  
  // Business
  industry      String?
  employeeCount Int?
  
  // Credit & Quota
  creditLimit   Decimal? @db.Decimal(12, 2)
  mouQuotaTotal Int      @default(0)
  mouQuotaUsed  Int      @default(0)
  
  // Meta
  status        ClientStatus @default(ACTIVE)
  notes         String?
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  createdBy     User       @relation("CreatedBy", fields: [createdById], references: [id])
  workers       Worker[]
  documents     Document[]
  orders        Order[]
  payrollFiles  PayrollFile[]
  
  @@index([status])
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// =========================================
// Documents
// =========================================
model Document {
  id            String          @id @default(cuid())
  documentId    String          @unique // Auto: DOC-YYMMDD-XXXX
  
  type          DocumentType
  category      String? // Passport, Visa, WorkPermit, Contract, etc.
  title         String
  description   String?
  
  // File Storage (MinIO)
  fileUrl       String
  fileName      String
  fileSize      Int?  // bytes
  mimeType      String
  
  // Dates
  issueDate     DateTime?
  expiryDate    DateTime?
  
  // Meta
  status        DocumentStatus @default(PENDING)
  uploadedById  String?
  verifiedById  String?
  verifiedAt    DateTime?
  
  // Relations (Polymorphic)
  workerId      String?
  agentId       String?
  clientId      String?
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  worker        Worker?        @relation(fields: [workerId], references: [id])
  agent         Agent?         @relation(fields: [agentId], references: [id])
  client        Client?        @relation(fields: [clientId], references: [id])
  
  @@index([type])
  @@index([status])
  @@index([expiryDate])
  @@index([workerId])
}

enum DocumentType {
  WORKER_DOC
  AGENT_DOC
  CLIENT_DOC
  SYSTEM_DOC
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

// =========================================
// Financial: Loans
// =========================================
model Loan {
  id            String        @id @default(cuid())
  loanId        String        @unique // Auto: L-YYMMDD-XXXX
  
  workerId      String
  principal     Decimal       @db.Decimal(12, 2)
  interestRate  Decimal       @default(0) @db.Decimal(5, 2) // % per month
  balance       Decimal       @db.Decimal(12, 2)
  
  // Schedule
  disbursedAt   DateTime?
  dueDate       DateTime?
  
  // Meta
  status        LoanStatus    @default(ACTIVE)
  purpose       String?
  notes         String?
  createdById   String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relations
  worker        Worker        @relation(fields: [workerId], references: [id])
  createdBy     User          @relation("CreatedLoans", fields: [createdById], references: [id])
  payments      Payment[]
  
  @@index([status])
  @@index([workerId])
  @@index([dueDate])
}

enum LoanStatus {
  ACTIVE
  PAID_OFF
  OVERDUE
  WRITTEN_OFF
  CANCELLED
}

// =========================================
// Financial: Payments
// =========================================
model Payment {
  id            String        @id @default(cuid())
  paymentId     String        @unique // Auto: P-YYMMDD-XXXX
  
  loanId        String
  amount        Decimal       @db.Decimal(12, 2)
  method        PaymentMethod @default(CASH)
  
  paidAt        DateTime      @default(now())
  reference     String?
  notes         String?
  
  recordedById  String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relations
  loan          Loan          @relation(fields: [loanId], references: [id])
  recordedBy    User          @relation("RecordedPayments", fields: [recordedById], references: [id])
  
  @@index([loanId])
  @@index([paidAt])
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  MOBILE_BANKING
  PAYROLL_DEDUCTION
  OTHER
}

// =========================================
// Financial: Commissions
// =========================================
model Commission {
  id            String           @id @default(cuid())
  commissionId  String           @unique // Auto: COM-YYMMDD-XXXX
  
  agentId       String
  workerId      String?
  
  amount        Decimal          @db.Decimal(12, 2)
  type          CommissionType   @default(RECRUITMENT)
  
  // Calculation
  calculatedAt  DateTime         @default(now())
  calculatedById String
  
  // Approval
  status        CommissionStatus @default(PENDING)
  approvedAt    DateTime?
  approvedById  String?
  paidAt        DateTime?
  
  notes         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  
  // Relations
  agent         Agent            @relation(fields: [agentId], references: [id])
  calculatedBy  User             @relation("CalculatedCommissions", fields: [calculatedById], references: [id])
  approvedBy    User?            @relation("ApprovedCommissions", fields: [approvedById], references: [id])
  
  @@index([status])
  @@index([agentId])
}

enum CommissionType {
  RECRUITMENT   // จากการส่งแรงงาน
  RETENTION     // จากการรักษาแรงงาน
  PERFORMANCE   // โบนัสพิเศษ
  OTHER
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
}

// =========================================
// Academy Materials
// =========================================
model Material {
  id            String      @id @default(cuid())
  materialId    String      @unique // Auto: MAT-XXXX
  
  name          String
  nameEN        String?
  nameLA        String?
  category      String      // Uniform, Books, Tools, etc.
  
  unitPrice     Decimal     @db.Decimal(12, 2)
  stockQuantity Int         @default(0)
  
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  issued        MaterialIssue[]
}

model MaterialIssue {
  id            String      @id @default(cuid())
  issueId       String      @unique // Auto: ISS-YYMMDD-XXXX
  
  materialId    String
  agentId       String?
  quantity      Int
  unitPrice     Decimal     @db.Decimal(12, 2)
  totalPrice    Decimal     @db.Decimal(12, 2)
  
  issuedAt      DateTime    @default(now())
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  material      Material    @relation(fields: [materialId], references: [id])
  agent         Agent?      @relation(fields: [agentId], references: [id])
  
  @@index([materialId])
  @@index([agentId])
}

// =========================================
// Orders (สำหรับลูกค้าสั่งแรงงาน)
// =========================================
model Order {
  id            String      @id @default(cuid())
  orderId       String      @unique // Auto: ORD-YYMMDD-XXXX
  
  clientId      String
  
  // Request
  requestedCount Int
  gender        Gender?
  skills        String[]
  startDate     DateTime
  
  // Quotation
  pricePerHead  Decimal?    @db.Decimal(12, 2)
  totalPrice    Decimal?    @db.Decimal(12, 2)
  
  // Status
  status        OrderStatus @default(DRAFT)
  approvedAt    DateTime?
  
  // Deployment
  assignedWorkerIds String[]
  deployedAt    DateTime?
  
  // Meta
  notes         String?
  createdById   String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  client        Client      @relation(fields: [clientId], references: [id])
  
  @@index([status])
  @@index([clientId])
}

enum OrderStatus {
  DRAFT
  QUOTED
  APPROVED
  DEPLOYING
  COMPLETED
  CANCELLED
}

// =========================================
// Payroll Files
// =========================================
model PayrollFile {
  id            String        @id @default(cuid())
  payrollId     String        @unique // Auto: PAY-YYMMDD-XXXX
  
  clientId      String
  
  // File Info
  fileName      String
  fileUrl       String
  fileSize      Int?
  
  // Period
  payPeriodStart DateTime
  payPeriodEnd   DateTime
  
  // Summary
  workerCount   Int?
  totalAmount   Decimal?      @db.Decimal(12, 2)
  
  // Status
  status        PayrollStatus @default(PENDING)
  processedAt   DateTime?
  
  uploadedAt    DateTime      @default(now())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relations
  client        Client        @relation(fields: [clientId], references: [id])
  
  @@index([clientId])
  @@index([status])
}

enum PayrollStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// =========================================
// SOS Alerts
// =========================================
model SosAlert {
  id            String      @id @default(cuid())
  alertId       String      @unique // Auto: SOS-YYMMDD-XXXX
  
  workerId      String
  
  // Alert Info
  type          SosType
  priority      SosPriority @default(MEDIUM)
  description   String
  location      String?
  
  // Location Coords
  latitude      Float?
  longitude     Float?
  
  // Status
  status        SosStatus   @default(OPEN)
  resolvedAt    DateTime?
  resolvedById  String?
  resolution    String?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  worker        Worker      @relation(fields: [workerId], references: [id])
  resolvedBy    User?       @relation("ResolvedBy", fields: [resolvedById], references: [id])
  
  @@index([status])
  @@index([priority])
  @@index([workerId])
}

enum SosType {
  EMERGENCY       // ฉุกเฉิน
  HEALTH          // สุขภาพ
  LEGAL           // กฎหมาย
  WORKPLACE       // ที่ทำงาน
  DOCUMENT        // เอกสาร
  OTHER
}

enum SosPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SosStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

// =========================================
// Notifications
// =========================================
model Notification {
  id            String            @id @default(cuid())
  
  userId        String
  type          NotificationType
  title         String
  message       String
  
  // Link
  link          String?
  
  // Status
  isRead        Boolean           @default(false)
  readAt        DateTime?
  
  createdAt     DateTime          @default(now())
  
  // Relations
  user          User              @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  SYSTEM
  DOCUMENT_EXPIRY
  PAYMENT_DUE
  SOS_ALERT
  WORKER_STATUS
  COMMISSION
  OTHER
}

// =========================================
// Audit Logs
// =========================================
model AuditLog {
  id            String   @id @default(cuid())
  
  userId        String
  action        String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity        String   // Worker, Agent, Client, etc.
  entityId      String?
  
  // Changes
  oldValue      Json?
  newValue      Json?
  
  // Context
  ipAddress     String?
  userAgent     String?
  
  createdAt     DateTime @default(now())

  // Relations
  user          User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}

// =========================================
// Address System (NEW)
// =========================================
model Country {
  id        String     @id @default(cuid())
  code      String     @unique  // TH, LA
  nameEN    String
  nameTH    String?
  nameLO    String?
  latitude  Float?
  longitude Float?
  
  provinces Province[]
  
  @@index([code])
}

model Province {
  id         String     @id @default(cuid())
  code       String     @unique  // TH10, LA17
  nameEN     String
  nameTH     String?
  nameLO     String?
  countryCode String
  latitude   Float?
  longitude  Float?
  
  country    Country    @relation(fields: [countryCode], references: [code])
  districts  District[]
  
  @@index([countryCode])
  @@index([code])
}

model District {
  id           String        @id @default(cuid())
  code         String        @unique  // TH1001, LA1701
  nameEN       String
  nameTH       String?
  nameLO       String?
  provinceCode String
  latitude     Float?
  longitude    Float?
  
  province     Province      @relation(fields: [provinceCode], references: [code])
  subdistricts Subdistrict[]
  
  @@index([provinceCode])
  @@index([code])
}

model Subdistrict {
  id           String   @id @default(cuid())
  code         String   @unique  // TH100101 (only for Thailand)
  nameEN       String
  nameTH       String?
  districtCode String
  latitude     Float?
  longitude    Float?
  
  district     District @relation(fields: [districtCode], references: [code])
  
  @@index([districtCode])
  @@index([code])
}
