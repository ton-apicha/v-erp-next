// ===========================================
// V-ERP Prisma Schema
// Version: 2.0.0 (Multi-Company Rebuild)
// Updated: 2026-01-16
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================================
// ROLE & PERMISSION SYSTEM (NEW)
// =========================================

model Role {
  id            String   @id @default(cuid())
  name          String   @unique  // "SUPER_ADMIN", "LAO_MANAGER", etc.
  displayName   String             // "ผู้ดูแลระบบสูงสุด"
  displayNameLA String?            // "ຜູ້ເບິ່ງແຍງລະບົບ"
  description   String?
  
  // Company Access Control
  companyAccess String[]           // ["V_CONNECT", "V_WORK", "V_CARE", "V_HOLDING"]
  
  isSystem      Boolean  @default(false)  // ห้ามลบ/แก้ไข
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  permissions   RolePermission[]
  users         User[]
}

model Permission {
  id          String   @id @default(cuid())
  module      String             // "workers", "partners", "clients"
  action      String             // "create", "read", "update", "delete"
  displayName String             // "สร้างแรงงาน"
  displayNameLA String?          // "ສ້າງແຮງງານ"
  company     String?            // "V_CONNECT", "V_WORK" - ถ้า null คือ global
  
  createdAt   DateTime @default(now())
  
  // Relations
  roles       RolePermission[]
  
  @@unique([module, action])
  @@index([module])
  @@index([company])
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, permissionId])
}

// =========================================
// USER (Updated for Role System)
// =========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  
  // Role-based Access
  roleId        String
  role          Role      @relation(fields: [roleId], references: [id])
  
  // Preferences (Only TH/LA)
  language      String    @default("th")  // th, la
  
  // Meta
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  createdWorkers       Worker[]   @relation("CreatedBy")
  createdPartners      Partner[]  @relation("CreatedBy")
  createdClients       Client[]   @relation("CreatedBy")
  createdLoans         Loan[]     @relation("CreatedLoans")
  recordedPayments     Payment[]  @relation("RecordedPayments")
  auditLogs            AuditLog[]
  notifications        Notification[]
  sosResolutions       SosAlert[] @relation("ResolvedBy")
  
  @@index([roleId])
  @@index([isActive])
}

// =========================================
// AUDIT LOG (Full Field Tracking)
// =========================================

model AuditLog {
  id          String   @id @default(cuid())
  
  userId      String
  userEmail   String            // เก็บไว้เผื่อ User ถูกลบ
  userName    String            // ชื่อผู้ใช้ ณ ขณะนั้น
  
  action      String            // CREATE, UPDATE, DELETE, LOGIN, LOGOUT
  module      String            // workers, partners, clients, etc.
  recordId    String?           // ID ของ record ที่ถูกแก้ไข
  
  // Field-level changes (สำหรับ UPDATE)
  fieldChanges Json?            // [{ field, oldValue, newValue, displayName }]
  
  // Full snapshots
  fullBefore  Json?             // snapshot ก่อนแก้ไข (UPDATE, DELETE)
  fullAfter   Json?             // snapshot หลังแก้ไข (CREATE, UPDATE)
  
  // Request Info
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  // Relations
  user        User     @relation(fields: [userId], references: [id])
  
  @@index([module, recordId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// =========================================
// PARTNER (พาร์ทเนอร์ - ผู้พาแรงงานมา)
// =========================================

model Partner {
  id          String   @id @default(cuid())
  partnerId   String   @unique  // P-XXXX
  
  // Personal Info
  name        String            // ชื่อ
  nickname    String?           // ชื่อเล่น
  phoneNumber String
  
  // Address (Lao)
  address     String?
  village     String?           // บ้าน
  district    String?           // เมือง
  province    String?           // แขวง
  
  // Status & Notes
  status      PartnerStatus @default(ACTIVE)
  notes       String?
  
  // Meta
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  workers     Worker[]          // แรงงานที่พามา
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id])
  
  @@index([status])
  @@index([province])
}

enum PartnerStatus {
  ACTIVE      // ใช้งานได้
  INACTIVE    // หยุดชั่วคราว
  BLACKLISTED // ขึ้นบัญชีดำ
}

// =========================================
// WORKER (แรงงาน - Updated with Tags)
// =========================================

model Worker {
  id            String    @id @default(cuid())
  workerId      String    @unique // Auto: WK-XXXX
  
  // Personal Info
  firstNameTH   String
  lastNameTH    String
  firstNameLA   String?
  lastNameLA    String?
  nickname      String?
  gender        Gender
  dateOfBirth   DateTime
  nationality   String        @default("LAO")
  
  // Contact
  phoneNumber   String?
  address       String?
  village       String?
  district      String?
  province      String?
  
  // Emergency Contact
  emergencyName     String?
  emergencyPhone    String?
  emergencyRelation String?
  
  // ========== DOCUMENT TAGS (NEW) ==========
  hasIdCard         Boolean @default(false)  // มีบัตรประชาชน
  hasPassport       Boolean @default(false)  // มี Passport
  hasVisa           Boolean @default(false)  // มี Visa
  hasWorkPermit     Boolean @default(false)  // มีใบอนุญาตทำงาน
  hasMedicalCert    Boolean @default(false)  // มีใบรับรองแพทย์
  hasAcademyTraining Boolean @default(false) // ผ่านการฝึกอบรม
  
  // Document Numbers & Expiry
  passportNo        String?
  passportExpiry    DateTime?
  visaNo            String?
  visaExpiry        DateTime?
  workPermitNo      String?
  workPermitExpiry  DateTime?
  
  // Status & Assignment
  status            WorkerStatus @default(NEW)
  partnerId         String?           // พาร์ทเนอร์ที่พามา
  clientId          String?           // ลูกค้า/โรงงานที่ทำงาน
  
  // Employment
  position          String?
  salary            Decimal?      @db.Decimal(12, 2)
  startDate         DateTime?
  endDate           DateTime?
  
  // Academy
  academyStartDate  DateTime?
  academyEndDate    DateTime?
  
  // Deployment
  deploymentDate    DateTime?
  returnDate        DateTime?
  
  // Health
  bloodType         String?
  allergies         String?
  medicalConditions String?
  
  // Photo
  photoUrl          String?
  
  // Meta
  isArchived        Boolean   @default(false)
  notes             String?
  createdById       String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  createdBy         User      @relation("CreatedBy", fields: [createdById], references: [id])
  partner           Partner?  @relation(fields: [partnerId], references: [id])
  client            Client?   @relation(fields: [clientId], references: [id])
  documents         Document[]
  loans             Loan[]
  sosAlerts         SosAlert[]
  
  @@index([status])
  @@index([partnerId])
  @@index([clientId])
  @@index([nationality])
  @@index([hasPassport, hasVisa, hasWorkPermit])
}

enum WorkerStatus {
  NEW           // ใหม่ - เพิ่งลงทะเบียน
  DOCUMENTING   // กำลังทำเอกสาร
  TRAINING      // กำลังฝึกอบรม (V-Academy)
  READY         // พร้อมส่งตัว
  DEPLOYED      // ส่งตัวแล้ว
  WORKING       // กำลังทำงาน
  COMPLETED     // ครบสัญญา
  TERMINATED    // ยกเลิก/ถูกเลิกจ้าง
  RETURNED      // กลับประเทศ
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

// =========================================
// CLIENT (ลูกค้า - โรงงาน + บุคคล)
// =========================================

model Client {
  id            String   @id @default(cuid())
  clientId      String   @unique  // CL-XXXX
  
  // Client Type
  type          ClientType        // FACTORY (V-Work) or INDIVIDUAL (V-Care)
  
  // Company Info (for FACTORY)
  companyName   String?
  companyNameLA String?
  
  // Individual Info (for INDIVIDUAL)
  personName    String?
  
  // Contact
  contactPerson String
  phoneNumber   String
  email         String?
  lineId        String?
  
  // Address
  address       String?
  province      String?
  
  // Business Info (for FACTORY)
  industry      String?
  taxId         String?
  employeeCount Int?
  
  // Quota & Credit
  mouQuotaTotal Int      @default(0)
  mouQuotaUsed  Int      @default(0)
  creditLimit   Decimal? @db.Decimal(12, 2)
  
  // Status
  status        ClientStatus @default(ACTIVE)
  notes         String?
  
  // Meta
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  createdBy     User       @relation("CreatedBy", fields: [createdById], references: [id])
  workers       Worker[]
  documents     Document[]
  orders        Order[]
  
  @@index([type])
  @@index([status])
  @@index([province])
}

enum ClientType {
  FACTORY     // โรงงาน (V-Work B2B)
  INDIVIDUAL  // บุคคล (V-Care B2C)
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// =========================================
// DOCUMENTS
// =========================================

model Document {
  id            String          @id @default(cuid())
  documentId    String          @unique // DOC-YYMMDD-XXXX
  
  type          DocumentType
  category      String?         // passport, visa, work_permit, contract, medical, etc.
  title         String
  description   String?
  
  // File Storage
  fileUrl       String
  fileName      String
  fileSize      Int?            // bytes
  mimeType      String
  
  // Dates
  issueDate     DateTime?
  expiryDate    DateTime?
  
  // Status
  status        DocumentStatus @default(PENDING)
  
  // Meta
  uploadedById  String?
  uploadedAt    DateTime       @default(now())
  
  // Relations (Polymorphic)
  workerId      String?
  clientId      String?
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  worker        Worker?        @relation(fields: [workerId], references: [id])
  client        Client?        @relation(fields: [clientId], references: [id])
  
  @@index([type])
  @@index([status])
  @@index([expiryDate])
  @@index([workerId])
  @@index([clientId])
}

enum DocumentType {
  WORKER_DOC
  CLIENT_DOC
  SYSTEM_DOC
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

// =========================================
// ORDERS (คำสั่งซื้อแรงงาน)
// =========================================

model Order {
  id              String      @id @default(cuid())
  orderId         String      @unique // ORD-YYMMDD-XXXX
  
  clientId        String
  
  // Request Details
  requestedCount  Int
  gender          Gender?
  skills          String[]
  startDate       DateTime
  
  // Quotation
  pricePerHead    Decimal?    @db.Decimal(12, 2)
  totalPrice      Decimal?    @db.Decimal(12, 2)
  
  // Status
  status          OrderStatus @default(DRAFT)
  approvedAt      DateTime?
  
  // Assignment
  assignedWorkerIds String[]
  deployedAt      DateTime?
  
  // Meta
  notes           String?
  createdById     String
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  client          Client      @relation(fields: [clientId], references: [id])
  
  @@index([status])
  @@index([clientId])
}

enum OrderStatus {
  DRAFT
  QUOTED
  APPROVED
  DEPLOYING
  COMPLETED
  CANCELLED
}

// =========================================
// FINANCIAL: LOANS
// =========================================

model Loan {
  id            String        @id @default(cuid())
  loanId        String        @unique // L-YYMMDD-XXXX
  
  workerId      String
  principal     Decimal       @db.Decimal(12, 2)
  interestRate  Decimal       @default(0) @db.Decimal(5, 2)
  balance       Decimal       @db.Decimal(12, 2)
  
  disbursedAt   DateTime?
  dueDate       DateTime?
  
  status        LoanStatus    @default(ACTIVE)
  purpose       String?
  notes         String?
  
  createdById   String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relations
  worker        Worker        @relation(fields: [workerId], references: [id])
  createdBy     User          @relation("CreatedLoans", fields: [createdById], references: [id])
  payments      Payment[]
  
  @@index([status])
  @@index([workerId])
}

enum LoanStatus {
  ACTIVE
  PAID_OFF
  OVERDUE
  WRITTEN_OFF
  CANCELLED
}

// =========================================
// FINANCIAL: PAYMENTS
// =========================================

model Payment {
  id            String        @id @default(cuid())
  paymentId     String        @unique // P-YYMMDD-XXXX
  
  loanId        String
  amount        Decimal       @db.Decimal(12, 2)
  method        PaymentMethod @default(CASH)
  
  paidAt        DateTime      @default(now())
  reference     String?
  notes         String?
  
  recordedById  String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Relations
  loan          Loan          @relation(fields: [loanId], references: [id])
  recordedBy    User          @relation("RecordedPayments", fields: [recordedById], references: [id])
  
  @@index([loanId])
  @@index([paidAt])
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  MOBILE_BANKING
  PAYROLL_DEDUCTION
  OTHER
}

// =========================================
// SOS ALERTS
// =========================================

model SosAlert {
  id            String      @id @default(cuid())
  alertId       String      @unique // SOS-YYMMDD-XXXX
  
  workerId      String
  
  type          SosType
  priority      SosPriority @default(MEDIUM)
  description   String
  location      String?
  
  latitude      Float?
  longitude     Float?
  
  status        SosStatus   @default(OPEN)
  resolvedAt    DateTime?
  resolvedById  String?
  resolution    String?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations
  worker        Worker      @relation(fields: [workerId], references: [id])
  resolvedBy    User?       @relation("ResolvedBy", fields: [resolvedById], references: [id])
  
  @@index([status])
  @@index([priority])
  @@index([workerId])
}

enum SosType {
  EMERGENCY
  HEALTH
  LEGAL
  WORKPLACE
  DOCUMENT
  OTHER
}

enum SosPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SosStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

// =========================================
// NOTIFICATIONS
// =========================================

model Notification {
  id            String            @id @default(cuid())
  
  userId        String
  type          NotificationType
  title         String
  titleLA       String?
  message       String
  messageLA     String?
  
  link          String?
  
  isRead        Boolean           @default(false)
  readAt        DateTime?
  
  createdAt     DateTime          @default(now())
  
  // Relations
  user          User              @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  SYSTEM
  DOCUMENT_EXPIRY
  PAYMENT_DUE
  SOS_ALERT
  WORKER_STATUS
  OTHER
}

// =========================================
// CONTRACT TEMPLATES (NEW)
// =========================================

model ContractTemplate {
  id            String   @id @default(cuid())
  
  name          String            // ชื่อ Template
  nameLA        String?           // ชื่อภาษาลาว
  category      String            // employment, service, mou
  
  // Content (Rich Text with Variables)
  contentTH     String?           // เนื้อหาภาษาไทย
  contentLA     String?           // เนื้อหาภาษาลาว
  
  // Variables used in template
  variables     String[]          // ["worker.name", "client.companyName", "contract.startDate"]
  
  isActive      Boolean  @default(true)
  
  createdById   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([category])
  @@index([isActive])
}

// =========================================
// ADDRESS SYSTEM
// =========================================

model Country {
  id        String     @id @default(cuid())
  code      String     @unique  // TH, LA
  nameEN    String
  nameTH    String?
  nameLA    String?
  latitude  Float?
  longitude Float?
  
  provinces Province[]
  
  @@index([code])
}

model Province {
  id         String     @id @default(cuid())
  code       String     @unique
  nameEN     String
  nameTH     String?
  nameLA     String?
  countryCode String
  latitude   Float?
  longitude  Float?
  
  country    Country    @relation(fields: [countryCode], references: [code])
  districts  District[]
  
  @@index([countryCode])
}

model District {
  id           String        @id @default(cuid())
  code         String        @unique
  nameEN       String
  nameTH       String?
  nameLA       String?
  provinceCode String
  latitude     Float?
  longitude    Float?
  
  province     Province      @relation(fields: [provinceCode], references: [code])
  subdistricts Subdistrict[]
  
  @@index([provinceCode])
}

model Subdistrict {
  id           String   @id @default(cuid())
  code         String   @unique
  nameEN       String
  nameTH       String?
  districtCode String
  latitude     Float?
  longitude    Float?
  
  district     District @relation(fields: [districtCode], references: [code])
  
  @@index([districtCode])
}

// =========================================
// CMS SYSTEM - Landing Page Management
// =========================================

model CmsPage {
  id          String    @id @default(cuid())
  slug        String    @unique  // "landing", "about", etc.
  
  titleTH     String
  titleLA     String?
  
  // SEO Meta
  metaTH      Json?     // { title, description, keywords }
  metaLA      Json?
  
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  
  // Relations
  sections    CmsSection[]
  
  createdById String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([slug])
  @@index([isPublished])
}

model CmsSection {
  id          String    @id @default(cuid())
  pageId      String
  key         String    // "hero", "stats", "faq", etc.
  order       Int       @default(0)
  isVisible   Boolean   @default(true)
  
  // Flexible JSON content for each locale
  contentTH   Json      // Structure depends on section type
  contentLA   Json?
  
  // Relations
  page        CmsPage   @relation(fields: [pageId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([pageId, key])
  @@index([pageId, order])
}

model CmsBlogPost {
  id          String    @id @default(cuid())
  slug        String    @unique
  
  titleTH     String
  titleLA     String?
  excerptTH   String?
  excerptLA   String?
  contentTH   String    @db.Text
  contentLA   String?   @db.Text
  
  coverImage  String?
  category    String?   // "news", "law", "tech", "tips"
  tags        String[]
  
  isPublished Boolean   @default(false)
  isFeatured  Boolean   @default(false)
  publishedAt DateTime?
  viewCount   Int       @default(0)
  
  authorId    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([category])
  @@index([isPublished, publishedAt])
  @@index([isFeatured])
}

model CmsMedia {
  id          String    @id @default(cuid())
  
  fileName    String
  originalName String
  fileUrl     String
  fileSize    Int       // bytes
  mimeType    String
  
  altTextTH   String?
  altTextLA   String?
  folder      String?   // "partners", "hero", "blog", etc.
  
  width       Int?
  height      Int?
  
  uploadedById String
  createdAt   DateTime  @default(now())
  
  @@index([folder])
  @@index([mimeType])
}

model CmsFaq {
  id          String    @id @default(cuid())
  
  questionTH  String
  questionLA  String?
  answerTH    String    @db.Text
  answerLA    String?   @db.Text
  
  category    String?   // "general", "legal", "service"
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([isActive, order])
  @@index([category])
}

model CmsPartner {
  id          String    @id @default(cuid())
  
  name        String
  logoUrl     String
  websiteUrl  String?
  
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([isActive, order])
}

model CmsIndustrialEstate {
  id          String    @id @default(cuid())
  
  nameTH      String
  nameLA      String?
  region      String    // "Samut Prakan", "Samut Sakhon", "EEC", "Central"
  
  latitude    Float
  longitude   Float
  
  workers     Int       @default(0)
  clients     Int       @default(0)
  
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([region])
  @@index([isActive])
}
